-- Создание таблицы для кодов ошибок BMW
CREATE TABLE IF NOT EXISTS error_codes (
  id SERIAL PRIMARY KEY,
  code VARCHAR(20) UNIQUE NOT NULL,
  title VARCHAR(255) NOT NULL,
  description TEXT NOT NULL,
  severity VARCHAR(50) NOT NULL, -- critical, warning, info
  common_causes TEXT[],
  symptoms TEXT[],
  solutions TEXT[],
  related_systems VARCHAR(100)[], -- engine, transmission, etc
  category VARCHAR(50) NOT NULL, -- obd2, bmw_specific
  search_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Индексы для быстрого поиска
CREATE INDEX idx_error_codes_code ON error_codes(code);
CREATE INDEX idx_error_codes_category ON error_codes(category);
CREATE INDEX idx_error_codes_search_count ON error_codes(search_count DESC);

-- Вставка популярных кодов ошибок
INSERT INTO error_codes (code, title, description, severity, common_causes, symptoms, solutions, related_systems, category) VALUES
('P0171', 'Слишком бедная смесь (Bank 1)', 'Система управления двигателем обнаружила, что топливно-воздушная смесь слишком бедная (недостаточно топлива или избыток воздуха) в первом ряду цилиндров.', 'warning', 
 ARRAY['Утечка воздуха во впускной системе', 'Неисправность датчика массового расхода воздуха (MAF)', 'Засорённый топливный фильтр', 'Слабый топливный насос', 'Неисправные форсунки'],
 ARRAY['Повышенный расход топлива', 'Потеря мощности двигателя', 'Нестабильная работа на холостом ходу', 'Затруднённый запуск'],
 ARRAY['Проверка впускной системы на утечки', 'Диагностика датчика MAF', 'Замена топливного фильтра', 'Проверка давления топлива'],
 ARRAY['engine', 'fuel_system'], 'obd2'),

('P0300', 'Множественные пропуски зажигания', 'Обнаружены случайные пропуски зажигания в нескольких цилиндрах двигателя.', 'critical',
 ARRAY['Изношенные свечи зажигания', 'Неисправные катушки зажигания', 'Низкое давление топлива', 'Проблемы с компрессией', 'Неисправность системы зажигания'],
 ARRAY['Двигатель троит', 'Сильная вибрация', 'Потеря мощности', 'Повышенный расход топлива', 'Неровная работа'],
 ARRAY['Замена свечей зажигания', 'Проверка катушек зажигания', 'Диагностика компрессии', 'Проверка топливной системы'],
 ARRAY['engine', 'ignition'], 'obd2'),

('30FF', 'Ошибка DME (блок управления двигателем)', 'Внутренняя ошибка блока управления двигателем BMW. Требуется диагностика специализированным оборудованием.', 'critical',
 ARRAY['Сбой программного обеспечения DME', 'Проблемы с электропитанием', 'Неисправность самого блока', 'Ошибка после обновления ПО'],
 ARRAY['Не заводится двигатель', 'Аварийный режим работы', 'Отключение дополнительных систем', 'Мигание Check Engine'],
 ARRAY['Перезагрузка блока DME', 'Проверка питания и предохранителей', 'Обновление/перепрошивка ПО', 'Замена блока DME (в крайнем случае)'],
 ARRAY['engine', 'electronics'], 'bmw_specific'),

('00457A', 'Ошибка датчика положения коленвала', 'Проблема с датчиком положения коленчатого вала или его цепью.', 'critical',
 ARRAY['Неисправность датчика', 'Повреждение проводки', 'Загрязнение датчика', 'Износ зубчатого венца маховика'],
 ARRAY['Двигатель не заводится', 'Внезапная остановка двигателя', 'Рывки при движении', 'Неровная работа'],
 ARRAY['Проверка датчика и проводки', 'Очистка датчика', 'Проверка зазора датчика', 'Замена датчика'],
 ARRAY['engine', 'sensors'], 'bmw_specific'),

('P0128', 'Недостаточная температура охлаждающей жидкости', 'Двигатель не достигает рабочей температуры за отведённое время.', 'warning',
 ARRAY['Заклинивший термостат в открытом положении', 'Неисправность датчика температуры', 'Низкий уровень охлаждающей жидкости'],
 ARRAY['Медленный прогрев двигателя', 'Плохая работа печки', 'Повышенный расход топлива в холодную погоду'],
 ARRAY['Замена термостата', 'Проверка датчика температуры', 'Проверка уровня ОЖ'],
 ARRAY['cooling_system'], 'obd2'),

('P0420', 'Низкая эффективность катализатора', 'Эффективность каталитического нейтрализатора ниже порогового значения.', 'warning',
 ARRAY['Износ катализатора', 'Повреждение внутренней структуры', 'Загрязнение маслом или топливом', 'Неисправность кислородных датчиков'],
 ARRAY['Горит Check Engine', 'Снижение динамики', 'Повышенный расход топлива', 'Запах из выхлопной системы'],
 ARRAY['Диагностика кислородных датчиков', 'Проверка на утечки выхлопных газов', 'Замена катализатора'],
 ARRAY['exhaust_system'], 'obd2');

-- Создание таблицы для логирования поисковых запросов
CREATE TABLE IF NOT EXISTS error_code_searches (
  id SERIAL PRIMARY KEY,
  code VARCHAR(20) NOT NULL,
  found BOOLEAN NOT NULL,
  user_ip VARCHAR(45),
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_error_code_searches_code ON error_code_searches(code);
CREATE INDEX idx_error_code_searches_created_at ON error_code_searches(created_at DESC);